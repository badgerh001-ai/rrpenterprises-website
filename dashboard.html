<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titan Operations | RRP Enterprises</title>
    
    <script>
        const user = localStorage.getItem('rrp_user');
        if (!user) {
            window.location.href = 'services.html'; 
        }
    </script>

    <link rel="stylesheet" href="style.css?v=62">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* === DASHBOARD CORE STYLES === */
        body { padding-bottom: 100px; background-color: #000; }
        
        /* Header & Stats */
        .dash-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .user-profile { display: flex; align-items: center; gap: 12px; }
        .user-avatar { 
            width: 45px; height: 45px; background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2rem; color: #fff;
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.3);
        }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card {
            background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.08);
            padding: 25px; border-radius: 16px; text-align: center; transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: #0ea5e9; }
        .stat-number { font-size: 2.2rem; font-weight: 800; color: #fff; margin: 10px 0; }
        .stat-label { color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em; }

        /* Toolbar & Filters */
        .toolbar {
            display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; background: rgba(255,255,255,0.03);
            padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); align-items: center;
        }
        .search-box {
            flex: 1; display: flex; align-items: center; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0 15px;
        }
        .search-input {
            background: transparent; border: none; color: #fff; padding: 12px; width: 100%; outline: none;
        }
        .tool-btn {
            background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;
            font-size: 0.9rem; transition: 0.3s;
        }
        .tool-btn:hover { background: #0ea5e9; border-color: #0ea5e9; color: #000; }
        .tool-btn.primary { background: #22c55e; border-color: #22c55e; color: #000; font-weight: 700; }

        /* Database Table */
        .db-container {
            background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .db-wrapper { overflow-x: auto; }
        .db-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .db-table th { 
            text-align: left; padding: 18px; background: rgba(0,0,0,0.4); 
            color: #0ea5e9; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .db-table td { padding: 18px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #cbd5e1; font-size: 0.9rem; }
        .db-table tr:hover td { background: rgba(255,255,255,0.02); color: #fff; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .status-paid { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .status-due { background: rgba(234, 179, 8, 0.15); color: #facc15; }

        /* === ADVANCED MODAL === */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 5000;
            justify-content: center; align-items: flex-start; padding: 40px 20px; overflow-y: auto;
        }
        .modal-box {
            background: #0f172a; border: 1px solid rgba(255,255,255,0.15); border-radius: 20px;
            width: 100%; max-width: 900px; padding: 40px; position: relative;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5); margin: auto;
        }
        .close-modal { position: absolute; top: 20px; right: 20px; color: #94a3b8; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        /* Form Sections */
        .form-section-title { 
            color: #0ea5e9; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.1em; 
            margin: 25px 0 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; 
        }
        .form-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; color: #94a3b8; font-size: 0.75rem; margin-bottom: 5px; text-transform: uppercase; }
        .form-input { 
            width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; outline: none;
            font-family: monospace; font-size: 0.95rem;
        }
        .form-input:focus { border-color: #0ea5e9; background: rgba(0,0,0,0.3); }

        /* === PRINT STYLES (PROFESSIONAL HALF-PAGE) === */
        @media print {
            body * { visibility: hidden; }
            #print-container, #print-container * { visibility: visible; }
            #print-container { 
                position: absolute; left: 0; top: 0; width: 100%; 
                background: white; color: black;
            }
            @page { margin: 0; size: A4; }
            .no-print { display: none !important; }
        }

        #print-container { display: none; font-family: 'Arial', sans-serif; }
        
        /* The Receipt Card (Half Page) */
        .lr-copy-card {
            width: 100%; height: 49vh; /* Half Page */
            border-bottom: 2px dashed #000;
            padding: 20px 40px;
            box-sizing: border-box;
            position: relative;
        }
        .lr-copy-card:last-child { border-bottom: none; }

        .lr-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
        .brand-section h1 { margin: 0; font-size: 28px; font-weight: 900; text-transform: uppercase; color: #000; }
        .brand-section p { margin: 2px 0; font-size: 12px; color: #333; }
        .copy-label { border: 1px solid #000; padding: 5px 15px; font-weight: bold; font-size: 12px; background: #eee; border-radius: 4px; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .box-bordered { border: 1px solid #000; padding: 10px; font-size: 12px; height: 100%; }
        .box-title { font-weight: bold; text-decoration: underline; margin-bottom: 5px; display: block; }

        .lr-details-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px; }
        .lr-details-table th { border: 1px solid #000; padding: 6px; background: #f4f4f4; text-align: center; }
        .lr-details-table td { border: 1px solid #000; padding: 8px; text-align: center; }

        .terms-footer { display: flex; justify-content: space-between; align-items: flex-end; font-size: 11px; margin-top: 10px; }
        .signatures { display: flex; gap: 40px; }
        .sign-line { text-align: center; border-top: 1px solid #000; width: 120px; padding-top: 5px; font-weight: bold; }

        @media (max-width: 992px) {
            .form-grid-3, .form-grid-2 { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo-container">
                <img src="assets/logo.png" alt="RRP Logo" class="main-logo">
                <div class="logo-text">RRP <span>ENTERPRISES</span></div>
            </a>
            
            <div class="user-profile">
                <div class="user-avatar" id="user-initial">A</div>
                <button onclick="logout()" class="action-btn" style="width: auto; padding: 8px 15px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="container">
        
        <div class="dash-header">
            <div>
                <h1 style="font-size: 1.8rem; margin-bottom: 5px; color: #fff;">Operations Command</h1>
                <p style="color: #94a3b8;">Manage bookings, generate invoices, and track revenue.</p>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-number" style="color: #38bdf8;" id="stat-total">0</div>
                <div class="stat-label">Total Shipments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #22c55e;" id="stat-revenue">₹0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #facc15;" id="stat-pending">0</div>
                <div class="stat-label">Pending Payments</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <i class="fas fa-search" style="color: #94a3b8;"></i>
                <input type="text" id="search-input" class="search-input" placeholder="Search by LR No, Party Name..." oninput="filterTable()">
            </div>
            <button onclick="exportToCSV()" class="tool-btn">
                <i class="fas fa-file-excel"></i> Export CSV
            </button>
            <button onclick="openLRModal()" class="tool-btn primary">
                <i class="fas fa-plus-circle"></i> Create New LR
            </button>
        </div>

        <div class="db-container">
            <div class="db-wrapper">
                <table class="db-table" id="lr-table">
                    <thead>
                        <tr>
                            <th>LR No</th>
                            <th>Date</th>
                            <th>Consignor</th>
                            <th>Consignee</th>
                            <th>Destination</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="lrModal">
        <div class="modal-box">
            <button class="close-modal" onclick="closeLRModal()">&times;</button>
            <h2 style="color: #fff;">Generate Lorry Receipt</h2>
            <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 20px;">Fill in details to generate a legal transport document.</p>
            
            <form onsubmit="saveLR(event)">
                
                <div class="form-grid-3">
                    <div class="form-group">
                        <label class="form-label">LR Number</label>
                        <input type="text" id="lr_no" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="lr_date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Truck No</label>
                        <input type="text" id="lr_truck" class="form-input" placeholder="AP02..." required>
                    </div>
                </div>

                <div class="form-section-title">Party Details</div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label class="form-label">Consignor (Sender)</label>
                        <input type="text" id="consignor_name" class="form-input" placeholder="Company Name" required>
                        <input type="text" id="consignor_gst" class="form-input" placeholder="GSTIN" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Consignee (Receiver)</label>
                        <input type="text" id="consignee_name" class="form-input" placeholder="Company Name" required>
                        <input type="text" id="consignee_gst" class="form-input" placeholder="GSTIN" style="margin-top: 5px;">
                    </div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label class="form-label">From (Origin)</label>
                        <input type="text" id="lr_from" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">To (Destination)</label>
                        <input type="text" id="lr_to" class="form-input" required>
                    </div>
                </div>

                <div class="form-section-title">Consignment Details</div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label class="form-label">Goods Description</label>
                        <input type="text" id="goods_desc" class="form-input" placeholder="e.g. Steel Pipes" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Actual Weight (MT)</label>
                        <input type="number" id="weight_act" class="form-input" oninput="calcTotal()" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Charged Weight (MT)</label>
                        <input type="number" id="weight_chg" class="form-input" oninput="calcTotal()" required>
                    </div>
                </div>

                <div class="form-section-title">Billing & Tax</div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label class="form-label">Rate (Per MT)</label>
                        <input type="number" id="rate" class="form-input" oninput="calcTotal()" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Basic Freight</label>
                        <input type="number" id="freight_base" class="form-input" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Other Charges</label>
                        <input type="number" id="charges" class="form-input" placeholder="Hamali/Halt" oninput="calcTotal()">
                    </div>
                </div>

                <div class="form-grid-3">
                    <div class="form-group">
                        <label class="form-label">Total Amount</label>
                        <input type="number" id="total_amt" class="form-input" style="font-weight: bold; color: #facc15;" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Advance Paid</label>
                        <input type="number" id="advance" class="form-input" oninput="calcTotal()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Balance To Pay</label>
                        <input type="number" id="balance" class="form-input" style="font-weight: bold; color: #ef4444;" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" style="color: #fff;">GST Liability (RCM)</label>
                    <select id="gst_type" class="form-input">
                        <option value="RCM">GST Payable by Consignor/Consignee (RCM)</option>
                        <option value="FCM">GST Payable by GTA (12%)</option>
                        <option value="EXEMPT">Exempted</option>
                    </select>
                </div>

                <button type="submit" class="submit-btn">Save & Print Triplicate</button>
            </form>
        </div>
    </div>

    <div id="print-container">
        <div class="lr-copy-card">
            <div class="lr-header">
                <div class="brand-section">
                    <h1>RRP ENTERPRISES</h1>
                    <p>#6-4-994, Maruthi Nagar, 80ft Road, Anantapuramu - 515001 (A.P)</p>
                    <p>GSTIN: 37ABCDE1234F1Z5 | Mob: +91 94948 31803</p>
                </div>
                <div style="text-align: right;">
                    <div class="copy-label">ORIGINAL FOR CONSIGNOR</div>
                    <h3 style="margin: 5px 0 0;">LORRY RECEIPT</h3>
                </div>
            </div>

            <div class="info-grid">
                <div class="box-bordered">
                    <span class="box-title">CONSIGNOR (SENDER)</span>
                    <div class="p-consignor"></div>
                    <div><strong>From:</strong> <span class="p-from"></span></div>
                    <div><strong>GSTIN:</strong> <span class="p-consignor-gst"></span></div>
                </div>
                <div class="box-bordered">
                    <span class="box-title">CONSIGNEE (RECEIVER)</span>
                    <div class="p-consignee"></div>
                    <div><strong>To:</strong> <span class="p-to"></span></div>
                    <div><strong>GSTIN:</strong> <span class="p-consignee-gst"></span></div>
                </div>
            </div>

            <table class="lr-details-table">
                <tr>
                    <td rowspan="2" style="width: 15%;"><strong>LR No:</strong><br><span class="p-lrno" style="font-size: 16px; font-weight: bold;"></span></td>
                    <td rowspan="2" style="width: 15%;"><strong>Date:</strong><br><span class="p-date"></span></td>
                    <td rowspan="2" style="width: 15%;"><strong>Truck No:</strong><br><span class="p-truck"></span></td>
                    <th>Description</th>
                    <th>Weight</th>
                    <th>Rate</th>
                    <th>Freight</th>
                </tr>
                <tr>
                    <td><span class="p-goods"></span></td>
                    <td><span class="p-weight"></span> MT</td>
                    <td><span class="p-rate"></span></td>
                    <td><span class="p-freight"></span></td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align: left; font-size: 10px;">
                        <strong>GST Note:</strong> <span class="p-gst-note"></span>
                    </td>
                    <td colspan="3" style="text-align: right;"><strong>Other Charges:</strong></td>
                    <td><span class="p-charges"></span></td>
                </tr>
                <tr>
                    <td colspan="3" rowspan="2" style="text-align: left; vertical-align: top;">
                        <span class="box-title">Bank Details</span>
                        HDFC Bank | A/C: 502000...<br>IFSC: HDFC000... | Branch: Anantapur
                    </td>
                    <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                    <td><strong><span class="p-total"></span></strong></td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align: right;">Advance:</td>
                    <td><span class="p-advance"></span></td>
                </tr>
                <tr>
                    <td colspan="3" style="font-size: 10px; text-align: left;">
                        Subject to Anantapur Jurisdiction.
                    </td>
                    <td colspan="3" style="text-align: right; background: #eee;"><strong>BALANCE:</strong></td>
                    <td style="background: #eee;"><strong><span class="p-balance"></span></strong></td>
                </tr>
            </table>

            <div class="terms-footer">
                <div style="width: 60%;">
                    "Received the above goods in good condition."
                </div>
                <div class="signatures">
                    <div class="sign-line">Driver Sign</div>
                    <div class="sign-line">For RRP Enterprises</div>
                </div>
            </div>
        </div>

        <div class="lr-copy-card">
            <div class="lr-header">
                <div class="brand-section">
                    <h1>RRP ENTERPRISES</h1>
                    <p>#6-4-994, Maruthi Nagar, 80ft Road, Anantapuramu - 515001 (A.P)</p>
                    <p>GSTIN: 37ABCDE1234F1Z5 | Mob: +91 94948 31803</p>
                </div>
                <div style="text-align: right;">
                    <div class="copy-label">DUPLICATE FOR CONSIGNEE</div>
                    <h3 style="margin: 5px 0 0;">LORRY RECEIPT</h3>
                </div>
            </div>

            <div class="info-grid">
                <div class="box-bordered">
                    <span class="box-title">CONSIGNOR (SENDER)</span>
                    <div class="p-consignor-2"></div>
                    <div><strong>From:</strong> <span class="p-from-2"></span></div>
                    <div><strong>GSTIN:</strong> <span class="p-consignor-gst-2"></span></div>
                </div>
                <div class="box-bordered">
                    <span class="box-title">CONSIGNEE (RECEIVER)</span>
                    <div class="p-consignee-2"></div>
                    <div><strong>To:</strong> <span class="p-to-2"></span></div>
                    <div><strong>GSTIN:</strong> <span class="p-consignee-gst-2"></span></div>
                </div>
            </div>
            
            <table class="lr-details-table">
                <tr>
                    <td rowspan="2" style="width: 15%;"><strong>LR No:</strong><br><span class="p-lrno-2" style="font-size: 16px; font-weight: bold;"></span></td>
                    <td rowspan="2" style="width: 15%;"><strong>Date:</strong><br><span class="p-date-2"></span></td>
                    <td rowspan="2" style="width: 15%;"><strong>Truck No:</strong><br><span class="p-truck-2"></span></td>
                    <th>Description</th>
                    <th>Weight</th>
                    <th>Rate</th>
                    <th>Freight</th>
                </tr>
                <tr>
                    <td><span class="p-goods-2"></span></td>
                    <td><span class="p-weight-2"></span> MT</td>
                    <td><span class="p-rate-2"></span></td>
                    <td><span class="p-freight-2"></span></td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align: left; font-size: 10px;">
                        <strong>GST Note:</strong> <span class="p-gst-note-2"></span>
                    </td>
                    <td colspan="3" style="text-align: right;"><strong>Other Charges:</strong></td>
                    <td><span class="p-charges-2"></span></td>
                </tr>
                <tr>
                    <td colspan="3" rowspan="2" style="text-align: left; vertical-align: top;">
                        <span class="box-title">Bank Details</span>
                        HDFC Bank | A/C: 502000...<br>IFSC: HDFC000... | Branch: Anantapur
                    </td>
                    <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                    <td><strong><span class="p-total-2"></span></strong></td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align: right;">Advance:</td>
                    <td><span class="p-advance-2"></span></td>
                </tr>
                <tr>
                    <td colspan="3" style="font-size: 10px; text-align: left;">
                        Subject to Anantapur Jurisdiction.
                    </td>
                    <td colspan="3" style="text-align: right; background: #eee;"><strong>BALANCE:</strong></td>
                    <td style="background: #eee;"><strong><span class="p-balance-2"></span></strong></td>
                </tr>
            </table>

            <div class="terms-footer">
                <div style="width: 60%;">
                    "Received the above goods in good condition."
                </div>
                <div class="signatures">
                    <div class="sign-line">Driver Sign</div>
                    <div class="sign-line">For RRP Enterprises</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. INIT & AUTH ===
        document.addEventListener('DOMContentLoaded', () => {
            const userData = JSON.parse(localStorage.getItem('rrp_user_data'));
            if(userData) {
                document.getElementById('user-initial').innerText = userData.name.charAt(0).toUpperCase();
            }
            renderTable();
            
            // Default LR
            document.getElementById('lr_no').value = 'LR-' + new Date().getFullYear() + '-' + Math.floor(100 + Math.random() * 900);
            document.getElementById('lr_date').valueAsDate = new Date();
        });

        function logout() {
            if(confirm('Secure Logout?')) {
                localStorage.removeItem('rrp_user');
                window.location.href = 'services.html';
            }
        }

        // === 2. MODAL & CALCS ===
        const modal = document.getElementById('lrModal');
        function openLRModal() { modal.style.display = 'flex'; }
        function closeLRModal() { modal.style.display = 'none'; }
        
        function calcTotal() {
            const weight = parseFloat(document.getElementById('weight_chg').value) || 0;
            const rate = parseFloat(document.getElementById('rate').value) || 0;
            const charges = parseFloat(document.getElementById('charges').value) || 0;
            const advance = parseFloat(document.getElementById('advance').value) || 0;

            const baseFreight = weight * rate;
            const total = baseFreight + charges;
            const balance = total - advance;

            document.getElementById('freight_base').value = baseFreight.toFixed(2);
            document.getElementById('total_amt').value = total.toFixed(2);
            document.getElementById('balance').value = balance.toFixed(2);
        }

        // === 3. DATABASE OPERATIONS ===
        function saveLR(e) {
            e.preventDefault();
            
            const lrData = {
                no: document.getElementById('lr_no').value,
                date: document.getElementById('lr_date').value,
                truck: document.getElementById('lr_truck').value,
                from: document.getElementById('lr_from').value,
                to: document.getElementById('lr_to').value,
                consignor: document.getElementById('consignor_name').value,
                consignor_gst: document.getElementById('consignor_gst').value,
                consignee: document.getElementById('consignee_name').value,
                consignee_gst: document.getElementById('consignee_gst').value,
                goods: document.getElementById('goods_desc').value,
                weight: document.getElementById('weight_chg').value,
                rate: document.getElementById('rate').value,
                charges: document.getElementById('charges').value || 0,
                total: document.getElementById('total_amt').value,
                advance: document.getElementById('advance').value || 0,
                balance: document.getElementById('balance').value,
                gst_mode: document.getElementById('gst_type').value
            };

            let db = JSON.parse(localStorage.getItem('rrp_lr_master')) || [];
            db.unshift(lrData);
            localStorage.setItem('rrp_lr_master', JSON.stringify(db));

            renderTable();
            closeLRModal();
            printLR(lrData);
        }

        function renderTable(filter = "") {
            const db = JSON.parse(localStorage.getItem('rrp_lr_master')) || [];
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            let totalRev = 0, pendingCount = 0;

            db.forEach((lr, index) => {
                // Filter Logic
                if(filter && !JSON.stringify(lr).toLowerCase().includes(filter.toLowerCase())) return;

                totalRev += parseFloat(lr.total);
                if(parseFloat(lr.balance) > 0) pendingCount++;

                const statusClass = parseFloat(lr.balance) > 0 ? 'status-due' : 'status-paid';
                const statusText = parseFloat(lr.balance) > 0 ? 'Due' : 'Paid';

                const row = `
                    <tr>
                        <td style="color: #fff; font-weight: bold;">${lr.no}</td>
                        <td>${lr.date}</td>
                        <td>${lr.consignor}</td>
                        <td>${lr.consignee}</td>
                        <td>${lr.to}</td>
                        <td>₹${lr.total}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <i class="fas fa-print action-icon" onclick='printFromDB(${index})'></i>
                            <i class="fas fa-trash action-icon" onclick='deleteLR(${index})' style="color: #ef4444;"></i>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update Stats
            document.getElementById('stat-total').innerText = db.length;
            document.getElementById('stat-revenue').innerText = "₹" + totalRev.toLocaleString();
            document.getElementById('stat-pending').innerText = pendingCount;
        }

        function filterTable() {
            renderTable(document.getElementById('search-input').value);
        }

        function deleteLR(index) {
            if(confirm('Delete this record?')) {
                let db = JSON.parse(localStorage.getItem('rrp_lr_master'));
                db.splice(index, 1);
                localStorage.setItem('rrp_lr_master', JSON.stringify(db));
                renderTable();
            }
        }

        // === 4. EXPORT TO CSV ===
        function exportToCSV() {
            const db = JSON.parse(localStorage.getItem('rrp_lr_master'));
            if(!db || db.length === 0) { alert("No data to export"); return; }

            let csv = 'LR No,Date,Consignor,Consignee,Truck,Destination,Total Amount,Balance\n';
            db.forEach(row => {
                csv += `${row.no},${row.date},"${row.consignor}","${row.consignee}",${row.truck},"${row.to}",${row.total},${row.balance}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'RRP_Shipments_Export.csv';
            a.click();
        }

        // === 5. PRINT ENGINE ===
        function printFromDB(index) {
            const db = JSON.parse(localStorage.getItem('rrp_lr_master'));
            printLR(db[index]);
        }

        function printLR(lr) {
            // Function to fill a set of fields (Original & Duplicate)
            const fill = (suffix) => {
                document.querySelector(`.p-lrno${suffix}`).innerText = lr.no;
                document.querySelector(`.p-date${suffix}`).innerText = lr.date;
                document.querySelector(`.p-truck${suffix}`).innerText = lr.truck;
                document.querySelector(`.p-consignor${suffix}`).innerText = lr.consignor;
                document.querySelector(`.p-consignor-gst${suffix}`).innerText = lr.consignor_gst || "N/A";
                document.querySelector(`.p-consignee${suffix}`).innerText = lr.consignee;
                document.querySelector(`.p-consignee-gst${suffix}`).innerText = lr.consignee_gst || "N/A";
                document.querySelector(`.p-from${suffix}`).innerText = lr.from;
                document.querySelector(`.p-to${suffix}`).innerText = lr.to;
                document.querySelector(`.p-goods${suffix}`).innerText = lr.goods;
                document.querySelector(`.p-weight${suffix}`).innerText = lr.weight;
                document.querySelector(`.p-rate${suffix}`).innerText = lr.rate;
                document.querySelector(`.p-freight${suffix}`).innerText = (lr.weight * lr.rate).toFixed(2);
                document.querySelector(`.p-charges${suffix}`).innerText = lr.charges;
                document.querySelector(`.p-total${suffix}`).innerText = lr.total;
                document.querySelector(`.p-advance${suffix}`).innerText = lr.advance;
                document.querySelector(`.p-balance${suffix}`).innerText = lr.balance;
                
                let gstText = "GST Payable by Consignor/Consignee (RCM)";
                if(lr.gst_mode === 'FCM') gstText = "GST Paid by GTA @ 12%";
                if(lr.gst_mode === 'EXEMPT') gstText = "Exempted Category";
                document.querySelector(`.p-gst-note${suffix}`).innerText = gstText;
            };

            // Fill Copy 1 and Copy 2
            fill("");
            fill("-2");

            window.print();
        }
    </script>
</body>
</html>
