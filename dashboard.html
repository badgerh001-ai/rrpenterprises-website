<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titan Operations | RRP Enterprises</title>
    
    <script>
        const user = localStorage.getItem('rrp_user');
        if (!user) {
            window.location.href = 'services.html'; 
        }
    </script>

    <link rel="stylesheet" href="style.css?v=62">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* === DASHBOARD CORE STYLES (Screen Only) === */
        body { padding-bottom: 100px; background-color: #000; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .dash-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .user-profile { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 45px; height: 45px; background: linear-gradient(135deg, #0ea5e9, #3b82f6); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2rem; color: #fff; }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.08); padding: 25px; border-radius: 16px; text-align: center; }
        .stat-number { font-size: 2.2rem; font-weight: 800; color: #fff; margin: 10px 0; }
        .stat-label { color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em; }

        .toolbar { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); align-items: center; }
        .search-box { flex: 1; display: flex; align-items: center; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0 15px; }
        .search-input { background: transparent; border: none; color: #fff; padding: 12px; width: 100%; outline: none; }
        .tool-btn { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .tool-btn.primary { background: #22c55e; border-color: #22c55e; color: #000; font-weight: 700; }

        .db-container { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; overflow: hidden; }
        .db-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .db-table th { text-align: left; padding: 18px; background: rgba(0,0,0,0.4); color: #0ea5e9; font-size: 0.8rem; text-transform: uppercase; }
        .db-table td { padding: 18px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #cbd5e1; font-size: 0.9rem; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .status-paid { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .status-due { background: rgba(234, 179, 8, 0.15); color: #facc15; }

        /* === MODAL === */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 5000; justify-content: center; align-items: flex-start; padding: 40px 20px; overflow-y: auto; }
        .modal-box { background: #0f172a; border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; width: 100%; max-width: 900px; padding: 40px; position: relative; margin: auto; }
        .close-modal { position: absolute; top: 20px; right: 20px; color: #94a3b8; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        .form-section-title { color: #0ea5e9; font-size: 1rem; text-transform: uppercase; margin: 25px 0 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .form-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; color: #94a3b8; font-size: 0.75rem; margin-bottom: 5px; text-transform: uppercase; }
        .form-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; outline: none; }
        .submit-btn { width: 100%; padding: 14px; background: #0ea5e9; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px; font-size: 1rem; }

        /* === INDUSTRIAL PRINT STYLES (STRICT GRID) === */
        @media print {
            body * { visibility: hidden; }
            .navbar, .dash-header, .stat-grid, .toolbar, .db-container, .modal-overlay, .mobile-app-dock { display: none !important; }
            
            #print-container, #print-container * { visibility: visible; }
            #print-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; z-index: 9999; }
            @page { margin: 5mm; size: A4; }
        }

        #print-container { display: none; font-family: 'Arial', sans-serif; color: #000; }
        
        /* THE LR BOX */
        .lr-box {
            width: 100%; height: 32vh; /* Fits 3 on page */
            border: 2px solid #000;
            margin-bottom: 15px;
            box-sizing: border-box;
            display: flex; flex-direction: column;
        }

        /* ROW 1: HEADER */
        .lr-row-header { display: flex; border-bottom: 1px solid #000; height: 65px; }
        .lr-logo-area { width: 70px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #000; }
        .lr-company-area { flex: 1; padding: 5px 10px; }
        .lr-company-title { font-size: 18px; font-weight: 900; margin: 0; text-transform: uppercase; color: #000; }
        .lr-company-details { font-size: 10px; line-height: 1.2; margin: 2px 0 0 0; }
        .lr-copy-area { width: 120px; border-left: 1px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; background: #eee; }

        /* ROW 2: META DATA BAR */
        .lr-row-meta { display: flex; border-bottom: 1px solid #000; font-size: 11px; }
        .lr-meta-item { flex: 1; padding: 4px 8px; border-right: 1px solid #000; }
        .lr-meta-item:last-child { border-right: none; }
        .meta-label { font-weight: bold; margin-right: 5px; }

        /* ROW 3: CONSIGNOR / CONSIGNEE SPLIT */
        .lr-row-parties { display: flex; border-bottom: 1px solid #000; height: 75px; }
        .lr-party-box { flex: 1; padding: 5px; font-size: 11px; line-height: 1.3; }
        .lr-party-box:first-child { border-right: 1px solid #000; }
        .party-header { font-weight: bold; text-decoration: underline; display: block; margin-bottom: 2px; font-size: 10px; }

        /* ROW 4: ROUTE & VEHICLE */
        .lr-row-transport { display: flex; border-bottom: 1px solid #000; font-size: 11px; }
        .lr-trans-item { flex: 1; padding: 4px 8px; border-right: 1px solid #000; }
        .lr-trans-item:last-child { border-right: none; }

        /* ROW 5: GOODS TABLE (Fixed Height) */
        .lr-goods-table { width: 100%; border-collapse: collapse; font-size: 11px; flex: 1; }
        .lr-goods-table th { border-bottom: 1px solid #000; border-right: 1px solid #000; background: #eee; padding: 4px; text-align: center; }
        .lr-goods-table td { border-right: 1px solid #000; padding: 4px; text-align: center; vertical-align: top; }
        .lr-goods-table th:last-child, .lr-goods-table td:last-child { border-right: none; }

        /* ROW 6: FOOTER */
        .lr-footer { border-top: 1px solid #000; display: flex; height: 60px; }
        .lr-terms { flex: 2; padding: 5px; font-size: 9px; line-height: 1.2; border-right: 1px solid #000; }
        .lr-amounts { flex: 1; font-size: 11px; display: flex; flex-direction: column; }
        .amount-row { display: flex; justify-content: space-between; padding: 2px 5px; border-bottom: 1px solid #ccc; }
        .amount-row:last-child { border-bottom: none; font-weight: bold; background: #eee; }
        
        .lr-signatures { display: flex; justify-content: space-around; align-items: flex-end; padding: 5px; flex: 1; border-left: 1px solid #000; }
        .sign-place { text-align: center; font-size: 9px; font-weight: bold; border-top: 1px dashed #000; width: 40%; padding-top: 2px; }

        @media (max-width: 992px) {
            .form-grid-3, .form-grid-2 { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo-container">
                <img src="assets/logo.png" alt="RRP Logo" class="main-logo">
                <div class="logo-text">RRP <span>ENTERPRISES</span></div>
            </a>
            <div class="user-profile">
                <div class="user-avatar" id="user-initial">A</div>
                <button onclick="logout()" class="action-btn" style="width: auto; padding: 8px 15px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="dash-header">
            <div>
                <h1 style="font-size: 1.8rem; margin-bottom: 5px; color: #fff;">Operations Command</h1>
                <p style="color: #94a3b8;">Manage bookings, generate invoices, and track revenue.</p>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-number" style="color: #38bdf8;" id="stat-total">0</div>
                <div class="stat-label">Total Shipments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #22c55e;" id="stat-revenue">₹0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #facc15;" id="stat-pending">0</div>
                <div class="stat-label">Pending Payments</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <i class="fas fa-search" style="color: #94a3b8;"></i>
                <input type="text" id="search-input" class="search-input" placeholder="Search..." oninput="filterTable()">
            </div>
            <button onclick="exportToCSV()" class="tool-btn">
                <i class="fas fa-file-excel"></i> Export CSV
            </button>
            <button onclick="openLRModal()" class="tool-btn primary">
                <i class="fas fa-plus-circle"></i> Create New LR
            </button>
        </div>

        <div class="db-container">
            <div class="db-wrapper">
                <table class="db-table" id="lr-table">
                    <thead>
                        <tr>
                            <th>LR No</th>
                            <th>Date</th>
                            <th>Consignor</th>
                            <th>Consignee</th>
                            <th>Truck</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="lrModal">
        <div class="modal-box">
            <button class="close-modal" onclick="closeLRModal()">&times;</button>
            <h2 style="color: #fff;">Generate Consignment Note</h2>
            
            <form onsubmit="saveLR(event)">
                <div class="form-grid-3">
                    <div class="form-group">
                        <label class="form-label" style="color: #0ea5e9;">LR Number</label>
                        <input type="text" id="lr_no" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" style="color: #0ea5e9;">Date</label>
                        <input type="date" id="lr_date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">E-Way Bill No</label>
                        <input type="text" id="lr_eway" class="form-input">
                    </div>
                </div>

                <div class="form-section-title">Consignor & Consignee</div>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label class="form-label">Consignor Name</label>
                        <input type="text" id="consignor_name" class="form-input">
                        <textarea id="consignor_addr" class="form-input" placeholder="Address..." rows="2" style="margin-top: 5px;"></textarea>
                        <input type="text" id="consignor_gst" class="form-input" placeholder="GSTIN" style="margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Consignee Name</label>
                        <input type="text" id="consignee_name" class="form-input">
                        <textarea id="consignee_addr" class="form-input" placeholder="Address..." rows="2" style="margin-top: 5px;"></textarea>
                        <input type="text" id="consignee_gst" class="form-input" placeholder="GSTIN" style="margin-top: 5px;">
                    </div>
                </div>

                <div class="form-section-title">Transport Details</div>
                <div class="form-grid-3">
                    <div class="form-group"><label class="form-label">From</label><input type="text" id="lr_from" class="form-input"></div>
                    <div class="form-group"><label class="form-label">To</label><input type="text" id="lr_to" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Transport Mode</label><input type="text" id="lr_mode" class="form-input" placeholder="By Road"></div>
                </div>
                <div class="form-grid-3">
                    <div class="form-group"><label class="form-label">Vehicle No</label><input type="text" id="lr_truck" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Driver Name</label><input type="text" id="lr_driver" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Driver Mobile</label><input type="text" id="lr_driver_mob" class="form-input"></div>
                </div>

                <div class="form-section-title">Goods</div>
                <div class="form-grid-3">
                    <div class="form-group"><label class="form-label">Description</label><input type="text" id="goods_desc" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Qty/Bags</label><input type="text" id="goods_qty" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Weight</label><input type="text" id="goods_weight" class="form-input"></div>
                </div>

                <div class="form-section-title">Payment</div>
                <div class="form-grid-3">
                    <div class="form-group"><label class="form-label">Total Freight</label><input type="number" id="total_amt" class="form-input" oninput="calcTotal()"></div>
                    <div class="form-group"><label class="form-label">Advance</label><input type="number" id="advance" class="form-input" oninput="calcTotal()"></div>
                    <div class="form-group"><label class="form-label">Balance</label><input type="number" id="balance" class="form-input" readonly></div>
                </div>

                <button type="submit" class="submit-btn">Save & Print</button>
            </form>
        </div>
    </div>

    <div id="print-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderTable();
            document.getElementById('lr_no').value = 'RRP/25-26/' + Math.floor(100 + Math.random() * 900);
            document.getElementById('lr_date').valueAsDate = new Date();
        });

        function logout() {
            if(confirm('Secure Logout?')) {
                localStorage.removeItem('rrp_user');
                window.location.href = 'services.html';
            }
        }

        const modal = document.getElementById('lrModal');
        function openLRModal() { modal.style.display = 'flex'; }
        function closeLRModal() { modal.style.display = 'none'; }
        
        function calcTotal() {
            const total = parseFloat(document.getElementById('total_amt').value) || 0;
            const advance = parseFloat(document.getElementById('advance').value) || 0;
            document.getElementById('balance').value = (total - advance).toFixed(2);
        }

        function saveLR(e) {
            e.preventDefault();
            const lrData = {
                no: document.getElementById('lr_no').value,
                date: document.getElementById('lr_date').value,
                eway: document.getElementById('lr_eway').value || "-",
                consignor: document.getElementById('consignor_name').value || "-",
                consignor_addr: document.getElementById('consignor_addr').value || "-",
                consignor_gst: document.getElementById('consignor_gst').value || "-",
                consignee: document.getElementById('consignee_name').value || "-",
                consignee_addr: document.getElementById('consignee_addr').value || "-",
                consignee_gst: document.getElementById('consignee_gst').value || "-",
                from: document.getElementById('lr_from').value || "-",
                to: document.getElementById('lr_to').value || "-",
                mode: document.getElementById('lr_mode').value || "By Road",
                truck: document.getElementById('lr_truck').value || "-",
                driver: document.getElementById('lr_driver').value || "-",
                driver_mob: document.getElementById('lr_driver_mob').value || "-",
                goods: document.getElementById('goods_desc').value || "-",
                qty: document.getElementById('goods_qty').value || "-",
                weight: document.getElementById('goods_weight').value || "-",
                total: document.getElementById('total_amt').value || "0.00",
                advance: document.getElementById('advance').value || "0.00",
                balance: document.getElementById('balance').value || "0.00"
            };

            let db = JSON.parse(localStorage.getItem('rrp_lr_master')) || [];
            db.unshift(lrData);
            localStorage.setItem('rrp_lr_master', JSON.stringify(db));

            renderTable();
            closeLRModal();
            printLR(lrData);
        }

        function renderTable() {
            const db = JSON.parse(localStorage.getItem('rrp_lr_master')) || [];
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            let totalRev = 0, pendingCount = 0;

            db.forEach((lr, index) => {
                totalRev += parseFloat(lr.total) || 0;
                if(parseFloat(lr.balance) > 0) pendingCount++;
                const status = (parseFloat(lr.balance) > 0) ? 'Due' : 'Paid';
                const statusClass = status === 'Due' ? 'status-due' : 'status-paid';

                const row = `<tr>
                    <td style="color: #fff;">${lr.no}</td>
                    <td>${lr.date}</td>
                    <td>${lr.consignor}</td>
                    <td>${lr.consignee}</td>
                    <td>${lr.truck}</td>
                    <td>${lr.total}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>
                        <i class="fas fa-print tool-btn" style="padding:5px;" onclick='printFromDB(${index})'></i>
                        <i class="fas fa-trash tool-btn" style="padding:5px; background: #ef4444;" onclick='deleteLR(${index})'></i>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
            document.getElementById('stat-total').innerText = db.length;
            document.getElementById('stat-revenue').innerText = "₹" + totalRev.toLocaleString();
            document.getElementById('stat-pending').innerText = pendingCount;
        }

        function deleteLR(index) {
            if(confirm('Delete Record?')) {
                let db = JSON.parse(localStorage.getItem('rrp_lr_master'));
                db.splice(index, 1);
                localStorage.setItem('rrp_lr_master', JSON.stringify(db));
                renderTable();
            }
        }

        function exportToCSV() {
            const db = JSON.parse(localStorage.getItem('rrp_lr_master'));
            if(!db || db.length === 0) { alert("No Data"); return; }
            let csv = "LR No,Date,Consignor,Consignee,Total\n";
            db.forEach(r => csv += `${r.no},${r.date},"${r.consignor}","${r.consignee}",${r.total}\n`);
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='LR_Export.csv'; a.click();
        }

        function printFromDB(index) {
            const db = JSON.parse(localStorage.getItem('rrp_lr_master'));
            printLR(db[index]);
        }

        function printLR(lr) {
            const container = document.getElementById('print-container');
            container.innerHTML = ''; 

            const createCopy = (label) => {
                return `
                <div class="lr-box">
                    <div class="lr-row-header">
                        <div class="lr-logo-area"><img src="assets/logo.png" style="width: 50px;"></div>
                        <div class="lr-company-area">
                            <div class="lr-company-title">RRP ENTERPRISES</div>
                            <div class="lr-company-details">
                                #6-4-994, Maruthi Nagar, Anantapur, Andhra Pradesh-515001<br>
                                GSTIN: 37AQLPB4811H1Z0 | Email: contact@rrpenterprises.co.in<br>
                                Mobile: 9494831803, 9014881668
                            </div>
                        </div>
                        <div class="lr-copy-area">
                            CONSIGNMENT NOTE<br>
                            <span style="font-size: 9px; margin-top:5px; font-weight:normal;">${label}</span>
                        </div>
                    </div>

                    <div class="lr-row-meta">
                        <div class="lr-meta-item"><span class="meta-label">LR No:</span> ${lr.no}</div>
                        <div class="lr-meta-item"><span class="meta-label">Date:</span> ${lr.date}</div>
                        <div class="lr-meta-item"><span class="meta-label">E-Way Bill:</span> ${lr.eway}</div>
                    </div>

                    <div class="lr-row-parties">
                        <div class="lr-party-box">
                            <span class="party-header">CONSIGNOR (SENDER)</span>
                            <strong>${lr.consignor}</strong><br>
                            ${lr.consignor_addr}<br>
                            GST: ${lr.consignor_gst}
                        </div>
                        <div class="lr-party-box">
                            <span class="party-header">CONSIGNEE (RECEIVER)</span>
                            <strong>${lr.consignee}</strong><br>
                            ${lr.consignee_addr}<br>
                            GST: ${lr.consignee_gst}
                        </div>
                    </div>

                    <div class="lr-row-transport">
                        <div class="lr-trans-item"><span class="meta-label">From:</span> ${lr.from}</div>
                        <div class="lr-trans-item"><span class="meta-label">To:</span> ${lr.to}</div>
                        <div class="lr-trans-item"><span class="meta-label">Vehicle:</span> ${lr.truck}</div>
                        <div class="lr-trans-item"><span class="meta-label">Driver:</span> ${lr.driver}</div>
                    </div>

                    <table class="lr-goods-table">
                        <tr>
                            <th style="width: 10%;">S.No</th>
                            <th style="width: 50%;">Description of Goods</th>
                            <th style="width: 20%;">Qty/Bags</th>
                            <th style="width: 20%;">Weight</th>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td>${lr.goods}</td>
                            <td>${lr.qty}</td>
                            <td>${lr.weight}</td>
                        </tr>
                    </table>

                    <div class="lr-footer">
                        <div class="lr-terms">
                            <strong>Terms & Conditions:</strong><br>
                            • Goods transported at owner's risk unless declared otherwise.<br>
                            • RRP Enterprises is not responsible for leakage/damage.<br>
                            • Subject to Anantapur Jurisdiction.
                        </div>
                        <div class="lr-amounts">
                            <div class="amount-row"><span>Freight:</span> <span>${lr.total}</span></div>
                            <div class="amount-row"><span>Advance:</span> <span>${lr.advance}</span></div>
                            <div class="amount-row"><span>Balance:</span> <span>${lr.balance}</span></div>
                        </div>
                        <div class="lr-signatures">
                            <div class="sign-place">Driver Sign</div>
                            <div class="sign-place">Auth Sign</div>
                        </div>
                    </div>
                </div>
                `;
            };

            container.innerHTML += createCopy("CONSIGNOR COPY");
            container.innerHTML += createCopy("CONSIGNEE COPY");
            container.innerHTML += createCopy("DRIVER COPY");

            window.print();
        }
    </script>
</body>
</html>
